/*
@license
Webix <%= pkg.productName %> v.<%= pkg.version %>
This software is covered by Webix Trial License.
Usage without proper license is prohibited.
(c) XB Software Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).pivot={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}var r=function(){return(r=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function n(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var r=Array(t),n=0;for(e=0;e<i;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,n++)r[n]=o[a];return r}var o=function(){},a=function(){function t(t,e){this.webixJet=!0,this.webix=t,this._events=[],this._subs={},this._data={},e&&e.params&&t.extend(this._data,e.params)}return t.prototype.getRoot=function(){return this._root},t.prototype.destructor=function(){this._detachEvents(),this._destroySubs(),this._events=this._container=this.app=this._parent=this._root=null},t.prototype.setParam=function(t,e,i){if(this._data[t]!==e&&(this._data[t]=e,this._segment.update(t,e,0),i))return this.show(null)},t.prototype.getParam=function(t,e){var i=this._data[t];if(void 0!==i||!e)return i;var r=this.getParentView();return r?r.getParam(t,e):void 0},t.prototype.getUrl=function(){return this._segment.suburl()},t.prototype.getUrlString=function(){return this._segment.toString()},t.prototype.getParentView=function(){return this._parent},t.prototype.$$=function(t){if("string"==typeof t){var e=this.getRoot();return e.queryView((function(i){return(i.config.id===t||i.config.localId===t)&&i.$scope===e.$scope}),"self")}return t},t.prototype.on=function(t,e,i){var r=t.attachEvent(e,i);return this._events.push({obj:t,id:r}),r},t.prototype.contains=function(t){for(var e in this._subs){var i=this._subs[e].view;if(i===t||i.contains(t))return!0}return!1},t.prototype.getSubView=function(t){var e=this.getSubViewInfo(t);if(e)return e.subview.view},t.prototype.getSubViewInfo=function(t){var e=this._subs[t||"default"];return e?{subview:e,parent:this}:"_top"===t?(this._subs[t]={url:"",id:null,popup:!0},this.getSubViewInfo(t)):this._parent?this._parent.getSubViewInfo(t):null},t.prototype._detachEvents=function(){for(var t=this._events,e=t.length-1;e>=0;e--)t[e].obj.detachEvent(t[e].id)},t.prototype._destroySubs=function(){for(var t in this._subs){var e=this._subs[t].view;e&&e.destructor()}this._subs={}},t.prototype._init_url_data=function(){var t=this._segment.current();this._data={},this.webix.extend(this._data,t.params,!0)},t.prototype._getDefaultSub=function(){if(this._subs.default)return this._subs.default;for(var t in this._subs){var e=this._subs[t];if(!e.branch&&e.view&&"_top"!==t){var i=e.view._getDefaultSub();if(i)return i}}},t.prototype._routed_view=function(){var t=this.getParentView();if(!t)return!0;var e=t._getDefaultSub();return!(!e&&e!==this)&&t._routed_view()},t}();function s(t){"/"===t[0]&&(t=t.substr(1));for(var e=t.split("/"),i=[],r=0;r<e.length;r++){var n=e[r],o={},a=n.indexOf(":");if(-1===a&&(a=n.indexOf("?")),-1!==a)for(var s=0,u=n.substr(a+1).split(/[\:\?\&]/g);s<u.length;s++){var l=u[s].split("=");o[l[0]]=decodeURIComponent(l[1])}i[r]={page:a>-1?n.substr(0,a):n,params:o,isNew:!0}}return i}function u(t){for(var e=[],i=0,r=t;i<r.length;i++){var n=r[i];e.push("/"+n.page);var o=l(n.params);o&&e.push("?"+o)}return e.join("")}function l(t){var e=[];for(var i in t)"object"!=typeof t[i]&&(e.length&&e.push("&"),e.push(i+"="+encodeURIComponent(t[i])));return e.join("")}var c=function(){function t(t,e){this._next=1,this.route="string"==typeof t?{url:s(t),path:t}:t,this.index=e}return t.prototype.current=function(){return this.route.url[this.index]},t.prototype.next=function(){return this.route.url[this.index+this._next]},t.prototype.suburl=function(){return this.route.url.slice(this.index)},t.prototype.shift=function(e){var i=new t(this.route,this.index+this._next);return i.setParams(i.route.url,e,i.index),i},t.prototype.setParams=function(t,e,i){if(e){var r=t[i].params;for(var n in e)r[n]=e[n]}},t.prototype.refresh=function(){for(var t=this.route.url,e=this.index+1;e<t.length;e++)t[e].isNew=!0},t.prototype.toString=function(){var t=u(this.suburl());return t?t.substr(1):""},t.prototype._join=function(t,e){var i=this.route.url;if(null===t)return i;var r=this.route.url,n=!0;if(i=r.slice(0,this.index+(e?this._next:0)),t){i=i.concat(s(t));for(var o=0;o<i.length;o++)r[o]&&(i[o].view=r[o].view),n&&r[o]&&i[o].page===r[o].page?i[o].isNew=!1:i[o].isNew&&(n=!1)}return i},t.prototype.append=function(t){var e=this._join(t,!0);return this.route.path=u(e),this.route.url=e,this.route.path},t.prototype.show=function(t,e,i){var r=this,n=this._join(t.url,i);return this.setParams(n,t.params,this.index+(i?this._next:0)),new Promise((function(t,i){var a=u(n),s={url:n,redirect:a,confirm:Promise.resolve()},l=e?e.app:null;if(l&&!l.callEvent("app:guard",[s.redirect,e,s]))return void i(new o);s.confirm.catch((function(t){return i(t)})).then((function(){if(null!==s.redirect){if(s.redirect!==a)return l.show(s.redirect),void i(new o);r.route.path=a,r.route.url=n,t()}else i(new o)}))}))},t.prototype.size=function(t){this._next=t},t.prototype.split=function(){var e={url:this.route.url.slice(this.index+1),path:""};return e.url.length&&(e.path=u(e.url)),new t(e,0)},t.prototype.update=function(t,e,i){var r=this.route.url[this.index+(i||0)];if(!r)return this.route.url.push({page:"",params:{}}),this.update(t,e,i);""===t?r.page=e:r.params[t]=e,this.route.path=u(this.route.url)},t}(),p=function(t){function e(e,i){var r=t.call(this,e.webix)||this;return r.app=e,r._children=[],r}return i(e,t),e.prototype.ui=function(t,e){var i=(e=e||{}).container||t.container,r=this.app.createView(t);return this._children.push(r),r.render(i,this._segment,this),"object"!=typeof t||t instanceof a?r:r.getRoot()},e.prototype.show=function(t,e){if(e=e||{},"object"==typeof t){for(var i in t)this.setParam(i,t[i]);t=null}else{if("/"===t.substr(0,1))return this.app.show(t,e);if(0===t.indexOf("./")&&(t=t.substr(2)),0===t.indexOf("../")){var r=this.getParentView();return r?r.show(t.substr(3),e):this.app.show("/"+t.substr(3))}var n=this.getSubViewInfo(e.target);if(n){if(n.parent!==this)return n.parent.show(t,e);if(e.target&&"default"!==e.target)return this._renderFrameLock(e.target,n.subview,{url:t,params:e.params})}else if(t)return this.app.show("/"+t,e)}return this._show(this._segment,{url:t,params:e.params},this)},e.prototype._show=function(t,e,i){var r=this;return t.show(e,i,!0).then((function(){return r._init_url_data(),r._urlChange()})).then((function(){t.route.linkRouter&&(r.app.getRouter().set(t.route.path,{silent:!0}),r.app.callEvent("app:route",[t.route.path]))}))},e.prototype.init=function(t,e){},e.prototype.ready=function(t,e){},e.prototype.config=function(){this.app.webix.message("View:Config is not implemented")},e.prototype.urlChange=function(t,e){},e.prototype.destroy=function(){},e.prototype.destructor=function(){this.destroy(),this._destroyKids(),this._root&&(this._root.destructor(),t.prototype.destructor.call(this))},e.prototype.use=function(t,e){t(this.app,this,e)},e.prototype.refresh=function(){this.getUrl();return this.destroy(),this._destroyKids(),this._destroySubs(),this._detachEvents(),this._container.tagName&&this._root.destructor(),this._segment.refresh(),this._render(this._segment)},e.prototype.render=function(t,e,i){var r=this;"string"==typeof e&&(e=new c(e,0)),this._segment=e,this._parent=i,this._init_url_data();var n="string"==typeof(t=t||document.body)?this.webix.toNode(t):t;return this._container!==n?(this._container=n,this._render(e)):this._urlChange().then((function(){return r.getRoot()}))},e.prototype._render=function(t){var e=this,i=this.config();return i.then?i.then((function(i){return e._render_final(i,t)})):this._render_final(i,t)},e.prototype._render_final=function(t,e){var i,r=this,n=null,o=null,a=!1;if(this._container.tagName?o=this._container:(n=this._container).popup?(o=document.body,a=!0):o=this.webix.$$(n.id),!this.app||!o)return Promise.reject(null);var s=this._segment.current(),u={ui:{}};this.app.copyConfig(t,u.ui,this._subs),this.app.callEvent("app:render",[this,e,u]),u.ui.$scope=this,!n&&s.isNew&&s.view&&s.view.destructor();try{if(n&&!a){var l=o,c=l.getParentView();c&&"multiview"===c.name&&!u.ui.id&&(u.ui.id=l.config.id)}this._root=this.app.webix.ui(u.ui,o);var p=this._root;a&&p.setPosition&&!p.isVisible()&&p.show(),n&&(n.view&&n.view!==this&&n.view!==this.app&&n.view.destructor(),n.id=this._root.config.id,this.getParentView()||!this.app.app?n.view=this:n.view=this.app),s.isNew&&(s.view=this,s.isNew=!1),i=Promise.resolve(this._init(this._root,e)).then((function(){return r._urlChange().then((function(){return r._initUrl=null,r.ready(r._root,e.suburl())}))}))}catch(t){i=Promise.reject(t)}return i.catch((function(t){return r._initError(r,t)}))},e.prototype._init=function(t,e){return this.init(t,e.suburl())},e.prototype._urlChange=function(){var t=this;this.app.callEvent("app:urlchange",[this,this._segment]);var e=[];for(var i in this._subs){var r=this._subs[i],n=this._renderFrameLock(i,r,null);n&&e.push(n)}return Promise.all(e).then((function(){return t.urlChange(t._root,t._segment.suburl())}))},e.prototype._renderFrameLock=function(t,e,i){if(!e.lock){var r=this._renderFrame(t,e,i);r&&(e.lock=r.then((function(){return e.lock=null}),(function(){return e.lock=null})))}return e.lock},e.prototype._renderFrame=function(t,e,i){var r=this;if("default"===t){if(this._segment.next()){var n=i?i.params:null;return e.params&&(n=this.webix.extend(n||{},e.params)),this._createSubView(e,this._segment.shift(n))}e.view&&e.popup&&(e.view.destructor(),e.view=null)}if(null!==i&&(e.url=i.url,e.params&&(i.params=this.webix.extend(i.params||{},e.params))),e.route){if(null!==i)return e.route.show(i,e.view).then((function(){return r._createSubView(e,e.route)}));if(e.branch)return}var o=e.view;if(!o&&e.url){if("string"==typeof e.url)return e.route=new c(e.url,0),i&&e.route.setParams(e.route.route.url,i.params,0),e.params&&e.route.setParams(e.route.route.url,e.params,0),this._createSubView(e,e.route);"function"!=typeof e.url||o instanceof e.url||(o=new(this.app._override(e.url))(this.app,"")),o||(o=e.url)}if(o)return o.render(e,e.route||this._segment,this)},e.prototype._initError=function(t,e){return this.app&&this.app.error("app:error:initview",[e,t]),!0},e.prototype._createSubView=function(t,e){var i=this;return this.app.createFromURL(e.current()).then((function(r){return r.render(t,e,i)}))},e.prototype._destroyKids=function(){for(var t=this._children,e=t.length-1;e>=0;e--)t[e]&&t[e].destructor&&t[e].destructor();this._children=[]},e}(a),h=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r._ui=i.ui,r}return i(e,t),e.prototype.config=function(){return this._ui},e}(p),f=function(){function t(t,e,i){this.path="",this.app=i}return t.prototype.set=function(t,e){this.path=t;var i=this.app;i.app.getRouter().set(i._segment.append(this.path),{silent:!0})},t.prototype.get=function(){return this.path},t}(),d=!0,g=function(t){function e(e){var i=this,r=(e||{}).webix||window.webix;return e=r.extend({name:"App",version:"1.0",start:"/home"},e,!0),(i=t.call(this,r,e)||this).config=e,i.app=i.config.app,i.ready=Promise.resolve(),i._services={},i.webix.extend(i,i.webix.EventSystem),i}return i(e,t),e.prototype.getUrl=function(){return this._subSegment.suburl()},e.prototype.getUrlString=function(){return this._subSegment.toString()},e.prototype.getService=function(t){var e=this._services[t];return"function"==typeof e&&(e=this._services[t]=e(this)),e},e.prototype.setService=function(t,e){this._services[t]=e},e.prototype.destructor=function(){this.getSubView().destructor(),t.prototype.destructor.call(this)},e.prototype.copyConfig=function(t,e,i){if((t instanceof a||"function"==typeof t&&t.prototype instanceof a)&&(t={$subview:t}),void 0!==t.$subview)return this.addSubView(t,e,i);var r=t instanceof Array;for(var n in e=e||(r?[]:{}),t){var o=t[n];if("function"==typeof o&&o.prototype instanceof a&&(o={$subview:o}),!o||"object"!=typeof o||o instanceof this.webix.DataCollection||o instanceof RegExp||o instanceof Map)e[n]=o;else if(o instanceof Date)e[n]=new Date(o);else{var s=this.copyConfig(o,o instanceof Array?[]:{},i);null!==s&&(r?e.push(s):e[n]=s)}}return e},e.prototype.getRouter=function(){return this.$router},e.prototype.clickHandler=function(t,e){if(t&&(e=e||t.target||t.srcElement)&&e.getAttribute){var i=e.getAttribute("trigger");if(i)return this._forView(e,(function(t){return t.app.trigger(i)})),t.cancelBubble=!0,t.preventDefault();var r=e.getAttribute("route");if(r)return this._forView(e,(function(t){return t.show(r)})),t.cancelBubble=!0,t.preventDefault()}var n=e.parentNode;n&&this.clickHandler(t,n)},e.prototype.getRoot=function(){return this.getSubView().getRoot()},e.prototype.refresh=function(){var t=this;return this._subSegment?this.getSubView().refresh().then((function(e){return t.callEvent("app:route",[t.getUrl()]),e})):Promise.resolve(null)},e.prototype.loadView=function(t){var e=this,i=this.config.views,r=null;if(""===t)return Promise.resolve(this._loadError("",new Error("Webix Jet: Empty url segment")));try{i&&"string"==typeof(r="function"==typeof i?i(t):i[t])&&(t=r,r=null),r||("_hidden"===t?r={hidden:!0}:"_blank"===t?r={}:(t=t.replace(/\./g,"/"),r=this.require("jet-views",t)))}catch(e){r=this._loadError(t,e)}return r.then||(r=Promise.resolve(r)),r=r.then((function(t){return t.__esModule?t.default:t})).catch((function(i){return e._loadError(t,i)}))},e.prototype._forView=function(t,e){var i=this.webix.$$(t);i&&e(i.$scope)},e.prototype._loadViewDynamic=function(t){return null},e.prototype.createFromURL=function(t){var e=this;return t.isNew||!t.view?this.loadView(t.page).then((function(i){return e.createView(i,name,t.params)})):Promise.resolve(t.view)},e.prototype._override=function(t){var e=this.config.override;if(e){for(var i=void 0;t;)i=t,t=e.get(t);return i}return t},e.prototype.createView=function(t,i,r){if("function"==typeof(t=this._override(t))){if(t.prototype instanceof e)return new t({app:this,name:i,params:r,router:f});if(t.prototype instanceof a)return new t(this,{name:i,params:r});t=t(this)}return t instanceof a?t:new h(this,{name:i,ui:t})},e.prototype.show=function(t,e){return t&&this.app&&0==t.indexOf("//")?this.app.show(t.substr(1),e):this.render(this._container,t||this.config.start,e)},e.prototype.trigger=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.apply(t,e)},e.prototype.apply=function(t,e){this.callEvent(t,e)},e.prototype.action=function(t){return this.webix.bind((function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.apply(t,e)}),this)},e.prototype.on=function(t,e){this.attachEvent(t,e)},e.prototype.use=function(t,e){t(this,null,e)},e.prototype.error=function(t,e){if(this.callEvent(t,e),this.callEvent("app:error",e),this.config.debug)for(var i=0;i<e.length;i++)if(console.error(e[i]),e[i]instanceof Error){var r=e[i].message;0===r.indexOf("Module build failed")?(r=r.replace(/\x1b\[[0-9;]*m/g,""),document.body.innerHTML="<pre style='font-size:16px; background-color: #ec6873; color: #000; padding:10px;'>"+r+"</pre>"):(r+="<br><br>Check console for more details",this.webix.message({type:"error",text:r,expire:-1}))}},e.prototype.render=function(t,e,i){var r=this;this._container="string"==typeof t?this.webix.toNode(t):t||document.body;var n=null;!this.$router?(d&&"tagName"in this._container&&(this.webix.event(document.body,"click",(function(t){return r.clickHandler(t)})),d=!1),"string"==typeof e&&(e=new c(e,0)),this._subSegment=this._first_start(e),this._subSegment.route.linkRouter=!0):n="string"==typeof e?e:this.app?e.split().route.path||this.config.start:e.toString();var o=i?i.params:this.config.params||null,a=this.getSubView(),s=this._subSegment,u=s.show({url:n,params:o},a).then((function(){return r.createFromURL(s.current())})).then((function(e){return e.render(t,s)})).then((function(t){return r.$router.set(s.route.path,{silent:!0}),r.callEvent("app:route",[r.getUrl()]),t}));return this.ready=this.ready.then((function(){return u})),u},e.prototype.getSubView=function(){if(this._subSegment){var t=this._subSegment.current().view;if(t)return t}return new p(this,{})},e.prototype.require=function(t,e){return null},e.prototype._first_start=function(t){var e=this;this._segment=t;if(this.$router=new this.config.router((function(t){return setTimeout((function(){e.show(t).catch((function(t){if(!(t instanceof o))throw t}))}),1)}),this.config,this),this._container===document.body&&!1!==this.config.animation){var i=this._container;this.webix.html.addCss(i,"webixappstart"),setTimeout((function(){e.webix.html.removeCss(i,"webixappstart"),e.webix.html.addCss(i,"webixapp")}),10)}if(t){if(this.app){var r=t.current().view;t.current().view=this,t.next()?(t.refresh(),t=t.split()):t=new c(this.config.start,0),t.current().view=r}}else{var n=this.$router.get();n||(n=this.config.start,this.$router.set(n,{silent:!0})),t=new c(n,0)}return t},e.prototype._loadError=function(t,e){return this.error("app:error:resolve",[e,t]),{template:" "}},e.prototype.addSubView=function(t,e,i){var r=!0!==t.$subview?t.$subview:null,n=t.name||(r?this.webix.uid():"default");return e.id=t.id||"s"+this.webix.uid(),(i[n]={id:e.id,url:r,branch:t.branch,popup:t.popup,params:t.params}).popup?null:e},e}(a),v=function(){function t(t,e){var i=this;this.config=e||{},this._detectPrefix(),this.cb=t,window.onpopstate=function(){return i.cb(i.get())}}return t.prototype.set=function(t,e){var i=this;if(this.config.routes){var r=t.split("?",2);for(var n in this.config.routes)if(this.config.routes[n]===r[0]){t=n+(r.length>1?"?"+r[1]:"");break}}this.get()!==t&&window.history.pushState(null,null,this.prefix+this.sufix+t),e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){var t=this._getRaw().replace(this.prefix,"").replace(this.sufix,"");if(t="/"!==t&&"#"!==t?t:"",this.config.routes){var e=t.split("?",2),i=this.config.routes[e[0]];i&&(t=i+(e.length>1?"?"+e[1]:""))}return t},t.prototype._detectPrefix=function(){var t=this.config.routerPrefix;this.sufix="#"+(void 0===t?"!":t),this.prefix=document.location.href.split("#",2)[0]},t.prototype._getRaw=function(){return document.location.href},t}(),m=!1;function _(t){if(!m&&t){m=!0;var e=window;e.Promise||(e.Promise=t.promise);var i=t.version.split(".");10*i[0]+1*i[1]<53&&(t.ui.freeze=function(e){var i=e();return i&&i.then?i.then((function(e){return t.ui.$freeze=!1,t.ui.resize(),e})):(t.ui.$freeze=!1,t.ui.resize()),i});var r=t.ui.baselayout.prototype.addView,n=t.ui.baselayout.prototype.removeView,o={addView:function(t,e){if(this.$scope&&this.$scope.webixJet&&!t.queryView){var i=this.$scope,n={};t=i.app.copyConfig(t,{},n),r.apply(this,[t,e]);var o=function(t){i._renderFrame(t,n[t],null).then((function(){i._subs[t]=n[t]}))};for(var a in n)o(a);return t.id}return r.apply(this,arguments)},removeView:function(){if(n.apply(this,arguments),this.$scope&&this.$scope.webixJet){var e=this.$scope._subs;for(var i in e){var r=e[i];t.$$(r.id)||(r.view.destructor(),delete e[i])}}}};t.extend(t.ui.layout.prototype,o,!0),t.extend(t.ui.baselayout.prototype,o,!0),t.protoUI({name:"jetapp",$init:function(e){this.$app=new this.app(e);var i=t.uid().toString();e.body={id:i},this.$ready.push((function(){this.callEvent("onInit",[this.$app]),this.$app.render({id:i})}))}},t.ui.proxy,t.EventSystem)}}var w=function(t){function e(e){var i;return e.router=e.router||v,_((i=t.call(this,e)||this).webix),i}return i(e,t),e.prototype.require=function(t,e){return require(t+"/"+e)},e}(g),y=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}i(e,t),e.prototype._detectPrefix=function(){this.prefix="",this.sufix=this.config.routerPrefix||""},e.prototype._getRaw=function(){return document.location.pathname+(document.location.search||"")}}(v),function(){function t(t,e){this.path="",this.cb=t}return t.prototype.set=function(t,e){var i=this;this.path=t,e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){return this.path},t}());function b(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function x(t,e,i){for(var r in t)b(t,r)&&e.call(i||t,t[r],r,t)}function S(t){t="Warning: "+t,"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(t){}}var C=String.prototype.replace,$=String.prototype.split,V=function(t){var e=t%10;return 11!==t&&1===e?0:2<=e&&e<=4&&!(t>=12&&t<=14)?1:2},k={arabic:function(t){if(t<3)return t;var e=t%100;return e>=3&&e<=10?3:e>=11?4:5},bosnian_serbian:V,chinese:function(){return 0},croatian:V,french:function(t){return t>1?1:0},german:function(t){return 1!==t?1:0},russian:V,lithuanian:function(t){return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=9&&(t%100<11||t%100>19)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){if(1===t)return 0;var e=t%10;return 2<=e&&e<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!=1||t%100==11?1:0},slovenian:function(t){var e=t%100;return 1===e?0:2===e?1:3===e||4===e?2:3}},P={arabic:["ar"],bosnian_serbian:["bs-Latn-BA","bs-Cyrl-BA","srl-RS","sr-RS"],chinese:["id","id-ID","ja","ko","ko-KR","lo","ms","th","th-TH","zh"],croatian:["hr","hr-HR"],german:["fa","da","de","en","es","fi","el","he","hi-IN","hu","hu-HU","it","nl","no","pt","sv","tr"],french:["fr","tl","pt-br"],russian:["ru","ru-RU"],lithuanian:["lt"],czech:["cs","cs-CZ","sk"],polish:["pl"],icelandic:["is"],slovenian:["sl-SL"]};function R(t){var e,i=(e={},x(P,(function(t,i){x(t,(function(t){e[t]=i}))})),e);return i[t]||i[$.call(t,/-/,1)[0]]||i.en}function A(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var O=/\$/g,L=/%\{(.*?)\}/g;function E(t,e,i,r){if("string"!=typeof t)throw new TypeError("Polyglot.transformPhrase expects argument #1 to be string");if(null==e)return t;var n=t,o=r||L,a="number"==typeof e?{smart_count:e}:e;if(null!=a.smart_count&&n){var s=$.call(n,"||||");n=(s[function(t,e){return k[R(t)](e)}(i||"en",a.smart_count)]||s[0]).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}return n=C.call(n,o,(function(t,e){return b(a,e)&&null!=a[e]?C.call(a[e],O,"$$"):t}))}function F(t){var e=t||{};this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en";var i=e.allowMissing?E:null;this.onMissingKey="function"==typeof e.onMissingKey?e.onMissingKey:i,this.warn=e.warn||S,this.tokenRegex=function(t){var e=t&&t.prefix||"%{",i=t&&t.suffix||"}";if("||||"===e||"||||"===i)throw new RangeError('"||||" token is reserved for pluralization');return new RegExp(A(e)+"(.*?)"+A(i),"g")}(e.interpolation)}F.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},F.prototype.extend=function(t,e){x(t,(function(t,i){var r=e?e+"."+i:i;"object"==typeof t?this.extend(t,r):this.phrases[r]=t}),this)},F.prototype.unset=function(t,e){"string"==typeof t?delete this.phrases[t]:x(t,(function(t,i){var r=e?e+"."+i:i;"object"==typeof t?this.unset(t,r):delete this.phrases[r]}),this)},F.prototype.clear=function(){this.phrases={}},F.prototype.replace=function(t){this.clear(),this.extend(t)},F.prototype.t=function(t,e){var i,r,n=null==e?{}:e;if("string"==typeof this.phrases[t])i=this.phrases[t];else if("string"==typeof n._)i=n._;else if(this.onMissingKey){r=(0,this.onMissingKey)(t,n,this.currentLocale,this.tokenRegex)}else this.warn('Missing translation for key: "'+t+'"'),r=t;return"string"==typeof i&&(r=E(i,n,this.currentLocale,this.tokenRegex)),r},F.prototype.has=function(t){return b(this.phrases,t)},F.transformPhrase=function(t,e,i){return E(t,e,i)};var j=F;var I=window.webix;I&&_(I);var T=function(t,e,i){var r=(i=i||{}).storage,n=r?r.get("lang")||"en":i.lang||"en";function o(e,o,a){o.__esModule&&(o=o.default);var u={phrases:o};i.polyglot&&t.webix.extend(u,i.polyglot);var l=s.polyglot=new j(u);if(l.locale(e),s._=t.webix.bind(l.t,l),n=e,r&&r.put("lang",n),i.webix){var c=i.webix[e];c&&t.webix.i18n.setLocale(c)}return a?Promise.resolve():t.refresh()}function a(e,r){if(!1!==i.path){var n=(i.path?i.path+"/":"")+e;o(e,t.require("jet-locales",n),r)}}var s={getLang:function(){return n},setLang:a,setLangData:o,_:null,polyglot:null};t.setService("locale",s),a(n,!0)},D=window;D.Promise||(D.Promise=D.webix.promise);var M=!1;function H(t,e,i){var r=e.$width,n=e.$height;t.config._fillApp?t.define({width:r,height:n}):t.define({left:(r-t.$width)/2,top:(n-t.$height)/2}),i||t.resize()}function z(t,e){var i=e.getRoot();t.attachEvent("onHide",(function(){webix.html.removeCss(i.$view,"webix_win_inside"),i.enable()}));var r=e.attachEvent("view:resize",(function(){H(t,i)}));t.attachEvent("onDestruct",(function(){e.detachEvent(r)}))}var U=1;function G(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){return t[i]=e}})}function B(t,e){e=e||{};var i={},r={},n=function(t,e){var n=U++;return i[n]={mask:t,handler:e},e("*"===t?r:r[t],void 0,t),n},o=[],a=!1,s=function(t,e,r,n){if(a)o.push([t,e,r,n]);else for(var s=Object.keys(i),u=0;u<s.length;u++){var l=i[s[u]];l&&("*"!==l.mask&&l.mask!==t||l.handler(r,e,t,n))}};return Object.defineProperty(r,"$changes",{value:{attachEvent:n,detachEvent:function(t){delete i[t]}},enumerable:!1,configurable:!1}),Object.defineProperty(r,"$observe",{value:n,enumerable:!1,configurable:!1}),Object.defineProperty(r,"$batch",{value:function(t){if("function"!=typeof t){var e=t;t=function(){for(var t in e)r[t]=e[t]}}for(a=!0,t(r),a=!1;o.length;){var i=o.shift();s.apply(this,i)}},enumerable:!1,configurable:!1}),Object.defineProperty(r,"$extend",{value:function(t,i){for(var n in i=i||e,t)if(t.hasOwnProperty(n)){var o=t[n];i.nested&&"object"==typeof o&&o?r[n]=B(o,i):N(r,o,n,s)}},enumerable:!1,configurable:!1}),r.$extend(t,e),r}function N(t,e,i,r){Object.defineProperty(t,i,{get:function(){return e},set:function(t){if(null===e||null===t?e!==t:e.valueOf()!=t.valueOf()){var n=e;e=t,r(i,n,t,null)}},enumerable:!0,configurable:!1})}var W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this.State=this.getParam("state",!0),e={view:"chart",$mainView:!0,borderless:!0,localId:"data",xAxis:{},yAxis:{}};webix.extend(e,t.chart,!0),e.xAxis.template||(e.xAxis.template=function(t){return t[t.length-1]});var i={lines:t.chart.lines};return t.chart.scaleColor&&(i.color=i.lineColor=t.chart.scaleColor),webix.extend(e.xAxis,i,!0),webix.extend(e.yAxis,i,!0),e},e.prototype.init=function(){var t=this;this.Local=this.app.getService("local"),this.LoadData(),this.on(this.State.$changes,"structure",(function(e,i){i&&t.UpdateStructure()})),this.on(this.State.$changes,"chart",(function(e,i){i&&t.refresh()}))},e.prototype.LoadData=function(){var t=this;return this.Local.getData().then((function(e){t.UpdateChart(e)}))},e.prototype.UpdateStructure=function(){var t=this.Local.getPivotData();this.UpdateChart(t)},e.prototype.UpdateChart=function(t){this.$$("data").clearAll(),this.$$("data").removeAllSeries(),this.SetSeries(t.values),this.$$("data").parse(t.data)},e.prototype.SetSeries=function(t){for(var e=this,i=this.State.chart.type,r=this.app.getService("locale")._,n=function(n){if(o.$$("data").addSeries({value:function(t){return t[n]},alpha:"area"==i||"splineArea"==i?.7:1,color:t[n].color,tooltip:function(t){return t[n]},item:{color:t[n].color,borderColor:t[n].color},line:{color:t[n].color}}),t[n].text!=t[n].operation){var a=t[n].text.split(",");a=a.map((function(t){return e.Local.getField(t).value})).join(", "),t[n].text=a+" ("+r(t[n].operation)+")"}else t[n].text=o.Local.fixMath(t[n].operation)},o=this,a=0;a<t.length;a++)n(a);this.SetLegend(t)},e.prototype.SetLegend=function(t){var e=webix.extend({values:t,valign:"middle",align:"right",layout:"y"},this.State.chart.legend||{},!0);this.$$("data").define({legend:e})},e}(p);webix.protoUI({name:"pivot-portlet",$reorderOnly:!0,$drag:function(t){webix.html.addCss(this.$view,"portlet_in_drag");var e=webix.DragControl.getContext();e.source=e.from=t,webix.callEvent("onClick",[]);var i=this.$scope.app.getService("local"),r=this.getChildViews()[0].getValues(),n=r.name?i.getField(r.name).value:"";if(r.name2&&(n+=(n?", ":"")+i.getField(r.name2).value),webix.isUndefined(r.name)&&r.operation)n=i.fixMath(r.operation);else if(n)r.operation&&(n+=" ("+r.operation+")");else{n=(0,this.$scope.app.getService("locale")._)("Field not defined")}var o=webix.skin.$active;return'<div class="webix_pivot_portlet_drag" style="'+("width:"+(this.$width-o.inputHeight)+"px;height:"+this.$height+"px;")+'">\n\t\t\t\t<span class="webix_icon '+this.config.icon+'"></span>'+n+"\n\t\t\t</div>"}},webix.ui.portlet);var X=function(t){function e(e,i,r){var n=t.call(this,e,i)||this;return r||(r={}),n.plusLabel=r.plusLabel,n.field=r.field,n}return i(e,t),e.prototype.config=function(){var t=this,e=webix.skin.$active;return{borderless:!0,type:"clean",paddingY:8,rows:[{localId:"forms",type:"clean",rows:[]},{template:'<div class="webix_pivot_handle_add_value">\n\t\t\t\t\t\t<span class="webix_icon wxi-plus-circle"></span><span>'+this.plusLabel+"</span>\n\t\t\t\t\t</div>",css:"webix_pivot_add_value",height:e.inputHeight-2*e.inputPadding,localId:"addValue",onClick:{webix_pivot_handle_add_value:function(){var e=t.$$("forms").getChildViews();t.Add(null,e.length);var i=e[e.length-1].queryView({name:"name"});i&&(i.focus(),webix.html.triggerEvent(i.getInputNode(),"MouseEvent","click")),"values"!=t.field&&e.length==t.app.getState().fields.length&&t.$$("addValue").hide()}}}]}},e.prototype.init=function(){var t=this;this.on(webix,"onAfterPortletMove",(function(e){e==t.$$("forms")&&t.app.callEvent("property:change",[t.field,t.GetValue()])})),this.on(webix,"onPortletDrag",(function(t,e){if(t.$reorderOnly)return t.getParentView()===e.getParentView()}))},e.prototype.ListTemplate=function(t){var e=this._activeInput,i="values"==this.field&&e&&!e.$destructed&&"wavg"==e.getFormView().elements.operation.getValue(),r=this.getParentView().GetCorrections()[this.field],n=t.value;if(!i&&r){var o="webix_pivot_list_marker";return this.CheckCorrections(r,t.id)&&(o+=" webix_pivot_list_marker_fill"),'<div class="'+o+'"> '+n+"</div>"}return n},e.prototype.CheckCorrections=function(t,e){if(this._activeInput&&e==this._activeInput.getValue())return!0;for(var i=this.app.getStructure(),r=0;r<t.length;r++){var n=i[t[r]];if(n)if("string"==typeof n){if(n==e)return!0}else for(var o=0;o<n.length;o++){var a=n[o];if(a.name&&(a=a.name),a==e)return!0}}return!1},e.prototype.GetValue=function(){var t=this.$$("forms").getChildViews(),e=[];return t.forEach((function(t){var i=t.getChildViews()[0].getValues().name;i&&e.push(i)})),e},e.prototype.SetValue=function(t){for(var e=this.$$("forms"),i=e.getChildViews(),r=i.length-1;r>=0;r--)e.removeView(i[r]);for(r=0;r<t.length;r++)t[r].external||this.Add(t[r],r)},e.prototype.Add=function(t,e){var i=this;this.$$("forms").addView({view:"pivot-portlet",mode:"replace",borderless:!0,body:{view:"form",paddingY:0,paddingX:2,elements:[{margin:2,cols:this.ItemConfig(t,e)}],on:{onChange:function(){i.app.callEvent("property:change",[i.field,i.GetValue()])}}}})},e.prototype.ItemConfig=function(t){var e=this;return[{width:webix.skin.$active.inputHeight},{view:"richselect",name:"name",value:this.PrepareValue(t),options:{css:"webix_pivot_suggest",data:this.app.getState().fields,on:{onBeforeShow:function(){var t=webix.$$(this.config.master),e=t.$scope,i=e.GetValue();e._activeInput=t,this.getList().filter((function(r){return e.FilterSuggest(i,t.getValue(),r)}))}},body:{template:function(t){return e.ListTemplate(t)}}}},{view:"icon",icon:"wxi-close",css:"webix_pivot_close_icon",click:function(){var t=this.$scope;t.$$("addValue").show(),t.$$("forms").removeView(this.queryView("pivot-portlet","parent")),t.app.callEvent("property:change",[t.field,t.GetValue()])}}]},e.prototype.PrepareValue=function(t){return t?("object"==typeof t&&(t=t.name),webix.isArray(t)&&(t=t[0])):t="",t},e.prototype.FilterSuggest=function(t,e,i){return(i=i.id)==e||!t.find((function(t){return t.name&&(t=t.name),i==t}))},e}(p),Y=function(t){function e(e,i,r){var n=t.call(this,e,i,r)||this;n.Local=n.app.getService("local");var o=n.app.getService("locale")._;return n.typeName="operation",n.plusLabel=o("Add value"),n.field="values",n.operations=n.Local.operations,n.operations.map((function(t){return t.value=o(t.id),t})),n}return i(e,t),e.prototype.init=function(){var e=this;t.prototype.init.call(this),this.State=this.app.getState(),this.on(this.State.$changes,"mode",(function(t){e.ToggleColors("chart"==t)}))},e.prototype.GetValue=function(){var t=this.$$("forms").getChildViews(),e=[];return t.forEach((function(t){var i=t.getChildViews()[0].getValues({hidden:!1});webix.isUndefined(i.name2)||(i.name&&i.name2?(i.name=[i.name,i.name2],delete i.name2):i.name=""),""!=i.name&&e.push(i)})),e},e.prototype.ItemConfig=function(e,i){var r=t.prototype.ItemConfig.call(this,e);if(e&&!e.name)r.splice(1,1,{view:"label",css:"webix_pivot_complex_operation",name:"operation",label:this.Local.fixMath(e.operation),value:e.operation});else{var n=void 0;if(e)n=e.operation;else{var o=this.app.config.defaultOperation,a=Math.max(this.operations.findIndex((function(t){return t.id==o})),0);n=this.operations[a].id}r.splice(2,0,{view:"richselect",name:"operation",width:100,value:n,options:{css:"webix_pivot_suggest",data:this.operations},on:{onChange:function(t){this.$scope.SetOperation(t,this)}}}),r.splice(2,0,{view:"richselect",hidden:!e||"wavg"!=e.operation,value:e&&webix.isArray(e.name)?e.name[1]:"",name:"name2",options:{css:"webix_pivot_suggest",data:this.app.getState().fields}})}var s="mini"==webix.skin.$name||"compact"==webix.skin.$name,u=this.Local.getPalette(),l=e&&e.color||this.Local.getValueColor(i);return r.splice(1,0,{view:"colorpicker",hidden:"chart"!=this.State.mode,name:"color",css:"webix_pivot_value_color",value:l,width:s?30:38,suggest:{type:"colorboard",body:{width:150,height:150,view:"colorboard",palette:u}}}),r},e.prototype.ToggleColors=function(t){for(var e=this.$$("forms").getChildViews(),i=0;i<e.length;i++){var r=e[i].getChildViews()[0].elements.color;t?r.show():r.hide()}},e.prototype.FilterSuggest=function(){return!0},e.prototype.SetOperation=function(t,e){var i=e.getFormView();"wavg"==t?i.elements.name2.show():i.elements.name2.hide()},e}(X),q=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r.field="groupBy",r}return i(e,t),e.prototype.config=function(){var t=this;return{padding:10,rows:[{view:"richselect",localId:"group",options:{css:"webix_pivot_suggest",data:this.app.getState().fields,body:{template:function(e){return t.ListTemplate(e)}},on:{onBeforeShow:function(){t._activeInput=t.$$("group")}}},on:{onChange:function(e,i,r){"user"==r&&t.app.callEvent("property:change",[t.field,e])}}}]}},e.prototype.GetValue=function(){return this.$$("group").getValue()},e.prototype.SetValue=function(t){this.$$("group").setValue(t)},e}(X),K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{view:"form",complexData:!0,padding:10,elements:[{name:"type",view:"richselect",value:"bar",options:{css:"webix_pivot_suggest",data:[{id:"bar",value:e("Bar")},{id:"line",value:e("Line")},{id:"radar",value:e("Radar")},{id:"area",value:e("Area")},{id:"spline",value:e("Spline")},{id:"splineArea",value:e("Spline Area")}]}},{name:"xAxis.title",view:"text",label:e("X axis title"),batch:"axis"},{name:"yAxis.title",view:"text",label:e("Y axis title"),batch:"axis"},{name:"scaleColor",view:"colorpicker",editable:!0,label:e("Scale color"),suggest:{type:"colorboard",body:{width:150,height:150,view:"colorboard",palette:this.app.getService("local").getPalette()}}},{name:"scale",view:"checkbox",checkValue:"logarithmic",uncheckValue:"linear",labelWidth:0,labelRight:e("Logarithmic scale")},{name:"yAxis.lineShape",view:"checkbox",batch:"radar",checkValue:"arc",labelWidth:0,labelRight:e("Circled lines")},{name:"lines",view:"checkbox",labelWidth:0,labelRight:e("Lines")}],on:{onChange:function(e,i,r){"user"==r&&(t.innerChange=!0,t.State.chart=Object.assign({},t.getRoot().getValues()),t.handleVisibility(),delete t.innerChange)}}}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.on(this.State.$changes,"chart",(function(e){t.innerChange||(t.getRoot().setValues(e),t.handleVisibility())}))},e.prototype.handleVisibility=function(){var t=this.getRoot();"radar"==this.State.chart.type?t.showBatch("radar"):t.showBatch("axis")},e}(p),J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{view:"form",padding:10,elements:[{name:"cleanRows",localId:"cleanRows",view:"checkbox",labelWidth:0,labelRight:e("Clean rows")},{view:"label",height:20,label:e("Highlight")},{cols:[{name:"minX",view:"checkbox",labelWidth:0,labelRight:e("Min X")},{name:"maxX",view:"checkbox",labelWidth:0,labelRight:e("Max X")},{name:"minY",view:"checkbox",labelWidth:0,labelRight:e("Min Y")},{name:"maxY",view:"checkbox",labelWidth:0,labelRight:e("Max Y")}]},{view:"label",height:20,label:e("Footer")},{view:"radio",name:"footer",options:[{id:1,value:e("Off")},{id:2,value:e("On")},{id:3,value:e("Sum Only")}],value:1}],on:{onChange:function(e,i,r){if("user"==r){var n=t.OutValues(t.getRoot().getValues());t.innerChange=!0,t.State.datatable=Object.assign({},n),delete t.innerChange}}}}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.on(this.State.$changes,"datatable",(function(e){t.innerChange||t.getRoot().setValues(t.InValues(e))})),this.on(this.State.$changes,"mode",(function(e){"table"==e?t.$$("cleanRows").show():t.$$("cleanRows").hide()}))},e.prototype.InValues=function(t){return(t=webix.copy(t)).footer?t.footer="sumOnly"==t.footer?3:2:t.footer=1,t},e.prototype.OutValues=function(t){switch(t.footer){case"1":delete t.footer;break;case"2":t.footer=!0;break;case"3":t.footer="sumOnly"}return t},e}(p),Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return this.Config=this.app.config,this.State=this.app.getState(),this.Compact=this.getParam("compact",!0),{margin:0,rows:[{type:"form",borderless:!0,padding:{left:16,right:14,top:8,bottom:4},cols:[{},{view:"button",label:e("Done"),hotkey:"esc",autowidth:!0,css:"webix_primary",click:function(){return t.ToggleForm()}}]},{borderless:!0,view:"scrollview",scroll:"y",body:{view:"accordion",css:"webix_pivot_configuration",localId:"settings",multi:!0,type:"space",padding:{left:16,right:16,top:4,bottom:16},margin:20,rows:[this.GroupConfig(e("Rows"),"pt-rows",{name:"rows",$subview:new X(this.app,"",{field:"rows",plusLabel:e("Add row")})},"table"),this.GroupConfig(e("Columns"),"pt-columns",{name:"columns",$subview:new X(this.app,"",{field:"columns",plusLabel:e("Add column")})},"table"),this.GroupConfig(e("Values"),"pt-values",{name:"values",$subview:Y}),this.GroupConfig(e("Group By"),"pt-group",{name:"groupBy",$subview:q},"chart"),this.GroupConfig(e("Filters"),"pt-filter",{name:"filters",$subview:new X(this.app,"",{field:"filters",plusLabel:e("Add filter")})}),this.GroupConfig(e("Chart"),"pt-chart",{$subview:K},"chart"),this.GroupConfig(e("Table"),"wxi-columns",{$subview:J},"table"),{}]}}]}},e.prototype.init=function(){var t=this;this.on(this.State.$changes,"readonly",(function(e,i){webix.isUndefined(i)||t.ToggleForm()}))},e.prototype.ready=function(){var t=this;this.on(this.app,"property:change",(function(e,i){t.HandleFieldChange(e,i)})),this.on(this.State.$changes,"structure",(function(){t.innerChange||t.SetValues()})),this.on(this.State.$changes,"mode",(function(e,i){var r="chart"==e;t.$$("settings").showBatch(r?"chart":"table"),i&&(r||"chart"==i)&&t.SetValues()}))},e.prototype.ToggleForm=function(){this.State.config=!this.State.config},e.prototype.SetValues=function(){var t=this,e=this.State.structure;["rows","columns","values","filters","groupBy"].forEach((function(i){var r=e[i]||t.State[i];r&&t.getSubView(i).SetValue(r)}))},e.prototype.HandleFieldChange=function(t,e){var i=webix.copy(this.State.structure);"filters"==t?e=this.CorrectFilters(i,e):this.CorrectInputs(i,t,e),i[t]=e,this.innerChange=!0,this.app.setStructure(i),delete this.innerChange},e.prototype.GroupConfig=function(t,e,i,r){return{batch:r,header:'\n\t\t\t\t<span class="webix_icon webix_pivot_config_icon '+e+'"></span>\n\t\t\t\t<span class="webix_pivot_config_label">'+t+"</span>\n\t\t\t",body:i,borderless:!0}},e.prototype.GetCorrections=function(){return{rows:["columns","values","groupBy"],columns:["rows","values"],values:["rows","columns","groupBy"],groupBy:["rows","values"]}},e.prototype.CorrectFilters=function(t,e){for(var i=function(i){var r=t.filters.find((function(t){if(t.name==e[i])return!0}));e[i]={name:e[i]},r&&!r.external&&(e[i].value=r.value)},r=0;r<e.length;r++)i(r);var n=t.filters.filter((function(t){return t.external}));return e=e.concat(n)},e.prototype.CorrectInputs=function(t,e,i){var r=this,n=this.GetCorrections()[e];n&&("string"==typeof i&&(i=[i]),i=i.map((function(t){return t.name?t.name:t})),n.forEach((function(e){var n=r.getSubView(e),o=n.GetValue();"string"==typeof o?i.find((function(t){return t==o}))&&(o=""):o=o.filter((function(t){return t.name&&(t=t.name),-1==i.indexOf(t)})),t[e]=o,n.SetValue(o)})))},e}(p),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return this.app.getService("jet-win").updateConfig({view:"window",borderless:!0,fullscreen:!0,head:!1,body:{$subview:!0}})},e}(p),tt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return this.Local=this.app.getService("local"),{view:"popup",css:"webix_pivot_filter_popup",body:{view:"filter",field:"value",on:{onChange:function(e){if("user"==e){var i,r=t.app.getState(),n=webix.copy(r.structure);n.filters=n.filters.filter((function(e){var r=e.name==t.field,n=r&&!e.external;return n&&(i=e.value=t.filter.getValue()),!r||n})),r.structure=n,t.app.callEvent("filter:change",[t.field,i])}}}}}},e.prototype.Show=function(t,e){var i=this,r=this.getRoot(),n=this.filter=r.getBody();this.field=e.name;var o=n.getChildViews()[2],a=this.Local.getField(this.field),s=webix.copy(this.Local.collectFieldValues(this.field));o.clearAll(),o.parse(s),o.define({template:function(t){var e=t.value;return"date"==a.type&&(e=new Date(e)),a.predicate?i.app.config.predicates[a.predicate](e):e}}),n.define({mode:a.type}),n.config.value="",n.setValue(webix.copy(e.value||{})),r.show(t)},e}(p),et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;this.Compact=this.getParam("compact");var i=webix.skin.$active,r="mini"==webix.skin.$name||"compact"==webix.skin.$name,n={height:i.toolbarHeight,cols:[{view:"segmented",localId:"modes",align:"middle",inputHeight:i.inputHeight-i.inputPadding*(r?0:2),optionWidth:80,width:244,options:[{id:"table",value:e("Table")},{id:"tree",value:e("Tree")},{id:"chart",value:e("Chart")}],on:{onChange:function(e,i,r){"user"==r&&t.SetMode(e)}}},{width:i.dataPadding}]};return this.Compact&&(n.css="webix_pivot_footer",n.cols[1].width=0,n.cols.unshift({})),n},e.prototype.init=function(){var t=this;this.State=this.getParam("state"),this.on(this.State.$changes,"mode",(function(e){t.$$("modes").setValue(e)}))},e.prototype.SetMode=function(t){this.State.mode=t},e}(p),it=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t,e=this,i=this.app.getService("locale")._;if(this.Compact=this.getParam("compact"),this.State=this.getParam("state"),this.Compact)t={view:"icon",icon:"pt-settings",inputHeight:webix.skin.$active.buttonHeight,on:{onItemClick:function(){return e.ToggleConfig()}}};else{var r=i("Configure Pivot");t={view:"template",borderless:!0,width:28+webix.html.getTextSize(r,"webix_template webix_pivot_measure_size").width,template:function(){return"\n\t\t\t\t\t\t<span>"+r+'</span>\n\t\t\t\t\t\t<span class="pt-settings webix_pivot_toolbar_icon"></span>'},onClick:{webix_pivot_settings:function(){return e.ToggleConfig()}}}}t.localId="config",t.css="webix_pivot_settings",t.tooltip=i("Click to configure");var n=webix.env.$customScroll?0:this._GetScrollWidth(),o=webix.skin.$active.toolbarHeight+n,a="webix_pivot_toolbar";n&&(webix.html.addStyle(".webix_pivot_bar_with_scroll .webix_pivot_settings>.webix_template{ line-height: "+o+"px; }"),a+=" webix_pivot_bar_with_scroll");var s={css:a,margin:this.Compact?12:0,padding:{left:this.Compact?webix.skin.$active.inputPadding:0},height:o,cols:[t,this.GetFilters()]};return this.Compact||s.cols.push(et),s},e.prototype.init=function(){var t=this;this.filterPopup=this.ui(tt),this.on(this.State.$changes,"fields",(function(e){if(e.length){var i=t.$$("filters").getParentView();webix.ui(t.GetFilters(),i)}})),this.on(this.State.$changes,"structure",(function(e,i){if(i&&t.FiltersChanged(e,i)){var r=t.$$("filters").getParentView();webix.ui(t.GetFilters(),r)}})),this.on(this.State.$changes,"readonly",(function(e){t.ToggleReadonly(e)}))},e.prototype.FiltersChanged=function(t,e){if(t.filters.length!=e.filters.length)return!0;for(var i=0;i<t.filters.length;i++){var r=t.filters[i],n=e.filters[i];if(r.name!=n.name||r.external!=n.external)return!0;if(JSON.stringify(r.value)!=JSON.stringify(n.value))return!0}return!1},e.prototype.ToggleConfig=function(){this.State.config=!this.State.config},e.prototype.ToggleReadonly=function(t){t?this.$$("config").hide():this.$$("config").show()},e.prototype.GetFilters=function(){var t=this,e=this.State.structure,i=[];this.State.fields.length&&e.filters.forEach((function(e){e.external||i.push(t.FilterConfig(e))}));var r=webix.skin.$active,n=(r.toolbarHeight-r.buttonHeight)/2;return{view:"scrollview",borderless:!0,scroll:"x",body:{margin:8,padding:{left:this.Compact?0:8,top:n+r.inputPadding,bottom:n+r.inputPadding},localId:"filters",cols:i}}},e.prototype.FilterConfig=function(t){var e=this,i=this.app.getService("local").getField(t.name).value;return{view:"template",borderless:!0,width:(this.Compact?0:28)+webix.html.getTextSize(i,"webix_template webix_pivot_measure_size").width,css:"webix_pivot_filter",template:function(){var r=t.value,n=r&&(r.includes||r.condition.filter)?"webix_pivot_active_filter":"",o=e.Compact?"":"<span class='pt-filter webix_pivot_toolbar_icon'></span>";return'<div class="webix_pivot_filter_inner '+n+'">\n\t\t\t\t\t<span>'+i+"</span>\n\t\t\t\t\t"+o+"\n\t\t\t\t</div>"},onClick:{webix_pivot_filter:function(){this.$scope.filterPopup.Show(this.$view,t)}}}},e.prototype._GetScrollWidth=function(){var t=webix.html.create("DIV",{style:"visibility:hidden;overflow:scroll;"}),e=webix.html.create("DIV");document.body.appendChild(t),t.appendChild(e);var i=t.offsetWidth-e.offsetWidth;return t.parentNode.removeChild(t),i},e}(p),rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){M||(M=!0,webix.protoUI({name:"r-layout",sizeTrigger:function(t,e,i){this._compactValue=i,this._compactHandler=e,this._app=t;var r=t.config;this._forceCompact=r.params.forceCompact,this._compactWidth=r.compactWidth,this._forceCompact||this._checkTrigger(this.$view.width,i)},_checkTrigger:function(t,e){return!this._compactWidth||!(t<=this._compactWidth&&!e||t>this._compactWidth&&e)||(this._compactWidth=null,this._compactHandler(!e),!1)},$setSize:function(t,e){(this._forceCompact||this._checkTrigger(t,this._compactValue))&&webix.ui.layout.prototype.$setSize.call(this,t,e),this._app&&this._app.callEvent("view:resize",[])}},webix.ui.layout));var t=this.getParam("forceCompact");webix.isUndefined(t)||this.setParam("compact",t),this.Compact=this.getParam("compact");var e=[it,{view:"r-layout",localId:"main",cols:[{$subview:!0}]}];return this.Compact?e.push(et,{$subview:!0,name:"edit",popup:!0}):e[1].cols.push({view:"proxy",maxWidth:420,localId:"edit",css:"webix_pivot_config_container webix_shadow_medium",borderless:!0,hidden:!0,body:{$subview:!0,name:"edit"}}),{margin:0,rows:e,view:webix.isUndefined(t)?"r-layout":"layout"}},e.prototype.init=function(){var t=this,e=this.getParam("state");this.$$("main").sizeTrigger(this.app,(function(e){return t.SetCompactMode(e)}),!!this.Compact),this.on(e.$changes,"mode",(function(e){t.show("./"+("chart"==e?"chart":"table"))})),this.on(e.$changes,"config",(function(e){e?t.ShowConfig():t.HideConfig()}))},e.prototype.ShowConfig=function(){this.Compact?this.show("config.popup/config",{target:"edit"}):(this.$$("edit").show(),this.show("config",{target:"edit"}))},e.prototype.HideConfig=function(){this.show("_blank",{target:"edit"}),this.Compact||this.$$("edit").hide()},e.prototype.SetCompactMode=function(t){var e=this;webix.delay((function(){e.setParam("compact",t),t||webix.fullscreen.exit(),e.refresh()}))},e}(p),nt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){this.Config=this.app.config,this.Local=this.app.getService("local");var t=this.State=this.getParam("state",!0),e=t.structure.rows.length,i={view:"treetable",$mainView:!0,localId:"data",css:"webix_data_border webix_header_border",select:!0,leftSplit:"table"==t.mode?e:e?1:0,resizeColumn:!0,borderless:!0,columns:[],footer:t.datatable.footer};return webix.extend(i,t.datatable,!0),i},e.prototype.init=function(){var t=this;this.LoadData(),this.on(this.State.$changes,"structure",(function(e,i){i&&t.UpdateStructure()})),this.on(this.State.$changes,"datatable",(function(e,i){i&&t.refresh()})),this.on(this.State.$changes,"mode",(function(e,i){i&&"chart"!=i&&t.refresh()}))},e.prototype.LoadData=function(){var t=this;return this.Local.getData().then((function(e){t.UpdateTable(e)}))},e.prototype.UpdateStructure=function(){var t=this.Local.getPivotData();this.UpdateTable(t)},e.prototype.UpdateTable=function(t){var e=this.$$("data");e.clearAll();var i=this.State.structure.rows.length;e.config.leftSplit="table"==this.State.mode?i:i?1:0,e.refreshColumns(this.SetColumns(t.header,t.total,t.marks)),e.parse(t.data)},e.prototype.SetColumns=function(t,e,i){for(var r=this.app.getService("locale")._,n=this.State.structure.rows.length,o="table"==this.State.mode?n:n?1:0,a=0;a<t.length;a++)if(a<o)this.SetFirstColumn(t[a],!a&&this.State.datatable.footer,r);else{t[a].sort="int",t[a].format||(t[a].format=this.CellFormat),i&&(t[a].cssFormat=function(t,e,r,n){var o=i[r-1],a=o?o[n-1]:null;return a?a.join(" "):""});for(var s=t[a].header,u=0;u<s.length;u++){var l=s[u];l&&(u||"total"!=l.name?u==s.length-1&&(l.text=this.HeaderTemplate(l,r)):l.text=r("Total"))}e.length&&(t[a].footer=this.CellFormat(e[a]))}return t},e.prototype.SetFirstColumn=function(t,e,i){var r=this;"tree"==this.State.mode?(t.header={text:this.State.structure.rows.map((function(t){return r.Local.getField(t).value})).join("<span class='webix_icon wxi-angle-right'></span>"),css:"webix_pivot_tree_header"},t.width=300,t.template=function(t,e){return e.treetable(t,e)+t[1]}):(t.header=this.Local.getField(t.header[0].text).value,t.width=200),e&&(t.footer=i("Total"))},e.prototype.HeaderTemplate=function(t,e){var i=this;if(t.operation&&t.text!=t.operation){var r=t.text.split(",");return(r=r.map((function(t){return i.Local.getField(t).value})).join(", "))+' <span class="webix_pivot_operation">'+e(t.operation)+"</span>"}return this.Local.fixMath(t.text)},e.prototype.CellFormat=function(t){return t||(t=0===t?"0":""),t?parseFloat(t).toFixed(3):t},e}(p),ot={JetView:p};ot.chart=W,ot.config=Z,ot["config/popup"]=Q,ot["config/properties/chart"]=K,ot["config/properties/group"]=q,ot["config/properties"]=X,ot["config/properties/table"]=J,ot["config/properties/values"]=Y,ot.filter=tt,ot.main=rt,ot.mode=et,ot.table=nt,ot.toolbar=it;var at=function(t,e){return t.key>e.key?1:-1},st=function(t,e){return t.key<e.key?1:-1},ut=function(){function t(t,e,i,r,n){"desc"===n?this._sort=st:"asc"===n?this._sort=at:n&&(this._sort=function(t,e){return n(t.key,e.key)}),this._label=i,this._meta=r||null,this._table=t,this._getter=e,this._prepared=0}return t.prototype.getIndexes=function(){return this._indexes},t.prototype.getValue=function(t){return this._values[t].key},t.prototype.getSize=function(){return this._values.length},t.prototype.getLabel=function(){return this._label},t.prototype.getOptions=function(){return this._prepareOptions(),this._values.map((function(t){return t.key}))},t.prototype.getMeta=function(){return this._meta},t.prototype.reset=function(){this._prepared=0},t.prototype.prepare=function(){if(!(1&this._prepared)){this._prepared=1|this._prepared,this._prepareOptions();var t=this._table,e=this._getter,i=this._keys,r=t.count();this._values.forEach((function(t,e){return t.index=e}));for(var n=this._indexes=new Array(r),o=0;o<r;o++){var a=e(o);n[o]=i.get(a).index}}},t.prototype._prepareOptions=function(){if(!(2&this._prepared)){this._prepared=2|this._prepared;for(var t=this._table,e=this._getter,i=t.count(),r=this._keys=new Map,n=this._values=[],o=0;o<i;o++){var a=e(o);void 0===r.get(a)&&r.set(a,n[n.length]={key:a,index:0})}this._sort&&n.sort(this._sort)}},t}(),lt=function(){function t(t){this._pivot=t}return t.prototype.toArray=function(t){var e,i=t.cleanRows,r=t.filters,n=t.ops,o=t.total,a=t.marks,s=t.aggregateRows,u=t.aggregateColumns,l=[],c=this._pivot.getLimit().rows||0;this._pivot.filter(r),this._pivot.operations(n,[]),this._pivot.resetCursor();for(var p=0;(e=this._pivot.next())&&(l.push(e),c!==++p););var h=this._pivot.getWidth(),f=h[0],d=h[1];i&&this._cleanRows(l,f);var g={data:l,width:d+f,scaleWidth:f};return o&&(g.total=this._pivot.total(g,o)),g.allRows=this._pivot.aggregateRows(g,s)||[],g.allColumns=this._pivot.aggregateColumns(g,u)||[],a&&(g.marks=this._pivot.mark(g,a)),g},t.prototype.toNested=function(t){var e=t.filters,i=t.ops,r=t.groupOps,n=t.total,o=t.aggregateRows,a=t.aggregateColumns,s=t.marks;this._pivot.filter(e),this._pivot.operations(i,r||[]),this._pivot.resetCursor();var u=this._pivot.nested();return n&&(u.total=this._pivot.total(u,n)),u.allRows=this._pivot.aggregateRows(u,o)||[],u.allColumns=this._pivot.aggregateColumns(u,a)||[],s&&(u.marks=this._pivot.mark(u,s)),u},t.prototype.toXHeader=function(t,e){return this._pivot.getXHeader(t,e)},t.prototype._cleanRows=function(t,e){for(var i=t.length,r=new Array(e),n=0;n<i;n++)for(var o=t[n],a=0;a<e;a++){if(r[a]!==o[a]){for(var s=a;s<e;s++)r[s]=o[s];break}o[a]=""}},t}();function ct(t,e){return new Function(e.propertyName,e.methodName,e.contextName,"return "+function(t,e){for(var i="",r=t.length,n=0,o=!1,a=!1,s=0;n<r;){var u=t[n];if(n++,'"'===u)o?i+=t.substr(s,n-s):s=n-1,o=!o;else{if(o)continue;var l=","===u||"/"===u||"*"===u||"+"===u||"-"===u||"("===u||")"===u,c=" "===u||"\t"===u||" \n"===u||"\r"===u;if(a){if(!l&&!c)continue;var p=t.substr(s,n-s-1);i+="("===u?e.method(p):e.property(p),a=!1}if(c)continue;l||"0"===u||"1"===u||"2"===u||"3"===u||"4"===u||"5"===u||"6"===u||"7"===u||"8"===u||"9"===u?i+=u:(a=!0,s=n-1)}}return a&&(i+=e.property(t.substr(s,n-s))),i}(t,e))}function pt(t,e,i,r){var n=function(t,e){return ct(e,{propertyName:"d",methodName:"m",contextName:"c",property:function(e){var i=ft;return dt[i]=t.getColumn(e).getter,ft+=1,'c.array("'+i+'", c)'},method:function(t){return"m."+t.toLowerCase()}})}(t,i),o={table:t,order:e,from:0,to:0,array:function(t,e){for(var i=e.to-e.from,r=new Array(i),n=dt[t],o=0;o<i;o++)r[o]=n(e.order[o+e.from]);return r}};return function(t,e){return o.from=t,o.to=e,n(0,r,o)}}function ht(t,e){var i=ct(t,{propertyName:"d",methodName:"m",contextName:"c",property:function(){return"d"},method:function(t){return"m."+t.toLowerCase()}});return function(t){return i(t,e,null)}}var ft=0,dt=[];var gt=function(t,e){return function(i){return t(i)&&e(i)}};function vt(t,e,i,r){var n=r.getter(t,e);if("object"!=typeof i){var o=r.compare.eq(i);return function(t){return o(n(t))}}for(var a=Object.keys(i),s=null,u=function(t){var e=r.compare[a[t].toLowerCase()](i[a[t]]),o=function(t){return e(n(t))};s=s?gt(s,o):o},l=0;l<a.length;l++)u(l);return s}function mt(t,e,i,r){var n=function(t,e,i){for(var r=Object.keys(e),n=null,o=0;o<r.length;o++){var a=r[o],s=vt(t,a,e[a],i);n=n?gt(n,s):s}return n}(e,i,r);return t.filter((function(t){return n(t)}))}var _t=function(){function t(t,e,i,r,n){this._rows=e,this._cols=i,this._dims=e.concat(i),this._table=t,this._context=n,this._cursor=-1,this._order=this._base_order=this._sort(),this._data=this._dims.map((function(t){return t.getIndexes()})),this.filter(r,!0)}return t.prototype.resetCursor=function(){this._cursor=0,this._group=this._dims.map((function(){return null})),this._order.length&&(this._rows.length&&this._nextRow(),this._cols.length&&this._nextColumn())},t.prototype.next=function(){var t=this,e=t._cursor,i=t._cols,r=t._order,n=t._group,o=t._ops,a=t._rows;if(this._cursor>=r.length)return null;for(var s=a.length,u=new Array(s+o.length*i.length),l=0;l<s;l++)u[l]=a[l].getValue(n[l]);var c=this._rows.length?this._nextRow(i.length>0):r.length;return this._fillRow(u,e,c,s),this._cursor=c,u},t.prototype.nested=function(){for(var t=this._cols,e=this._order,i=this._rows,r=i.length,o=r>0?1:0,a=[{data:[],values:[]}],s=i.map((function(){return 0})),u=[],l=[],c=[],p=this._cursor,h=0,f=this._context.limit.rows,d=Math.min(this._context.limit.columns,(t.length?this._sizes[0]*t[0].getSize():0)+o);this._cursor<e.length;){var g=new Array(d);l=c,c=[].concat(this._group);var v=this._rows.length?this._nextRow(t.length>0):e.length;if(this._fillRow(g,p,v,o),r>0){for(var m=0;m<r;m++)if(c[m]!=l[m]){for(var _=m;_<r;_++){var w=_+1,y=w===r,b=a[w]={id:y?u.length+1:0,data:y?null:[],values:y?g:[i[_].getValue(c[_])]};s[w]=p,a[_].data.push(b)}break}g[0]=i[r-1].getValue(c[r-1]),a[r].values=g}else a[0].data.push({data:null,values:g});if(u.push(g),++h>=f)break;this._cursor=p=v}return this._fillGroupRowInner(a[0],0,n([null],this._groupOps).slice(0,i.length),d,o),{tree:a[0].data,data:u,width:d,scaleWidth:o}},t.prototype.getLimit=function(){return this._context.limit},t.prototype.getWidth=function(){return[this._rows.length,this._cols.length&&this._ops.length?this._cols[0].getSize()*this._sizes[0]:0]},t.prototype.getXHeader=function(t,e){var i=this._cols,r=this._rows,n=this._ops,o=this._opInfo,a=e||{},s=a.nonEmpty,u=a.meta,l=t.data,c=t.tree,p=[],h=t.tree?Math.min(r.length,1):r.length,f=n.length,d=i.map((function(t){return t.getSize()})),g=d.reduce((function(t,e){return t*e}),f),v=Math.min(h+g,this._context.limit.columns),m=g,_=d.map((function(t){return m/=t})),w=[];if(this._cols.forEach((function(){return w.push(new Array(v))})),s){for(var y=0;y<h;y++)p.push(y);for(var b=h;b<v;b+=f)t:for(y=0;y<l.length;y++)if(void 0!==l[y][b]){for(var x=0;x<n.length;x++)p.push(b+x);break t}for(b=0;b<i.length;b++){var S=_[b],C=-1,$=0,V=0,k=void 0;for(y=h;y<p.length;y+=f){var P=p[y];if(P<$)V+=f;else 0!==V&&(w[b][C]={colspan:V,text:k}),C=P,$=((A=Math.floor((P-h)/S))+1)*S+h,V=f,k=i[b].getValue(A%d[b])}0!==V&&(w[b][C]={colspan:V,text:k})}}else for(y=0;y<i.length;y++){var R=d[y],A=(S=_[y],0);for(b=h;b<v;b+=S)w[y][b]=1===S?i[y].getValue(A++):{text:i[y].getValue(A++),colspan:S},A>=R&&(A=0)}if(this._ops){var O=new Array(v);for(S=n.length,b=h;b<v;b+=S)for(var L=0;L<S;L++)O[b+L]=o[L].label;w.push(O)}for(y=0;y<h;y++){var E=i.length+(this._ops?1:0);if(c){w[0][0]={text:"",rowspan:E};break}k=r[y].getLabel();w[0][y]=E>1?{text:k,rowspan:E}:k}var F={data:w};if(s&&(F.nonEmpty=p),u){var j=new Array(v);for(y=0;y<h;y++)j[y]=r[y].getMeta();for(S=n.length,b=h;b<v;b+=S)for(L=0;L<S;L++)j[b+L]=o[L].meta;F.meta=j}return F},t.prototype.filter=function(t,e){if(!t||0===Object.keys(t).length){if(e||!this._masterRules)return void(this._order=this._base_order);t=Object.assign(Object.assign({},this._masterRules),t)}e&&(this._masterRules=t),this._order=mt(this._base_order,this._table,t,this._context)},t.prototype.operations=function(t,e){var i=this._table,r=this._order,n=this._context;t=t||[],this._ops=t.map((function(t){return pt(i,r,"string"==typeof t?t:t.math,n.math)})),this._opInfo=t.map((function(t){return"string"==typeof t?{label:t,math:t}:Object.assign(Object.assign({},t),{label:t.label||t.math})})),this._groupOps=e.map((function(t){return t?t.map((function(t){return ht("string"==typeof t?t:t.math,n.math)})):null})),this._setSizes()},t.prototype.total=function(t,e){var i=this,r=e.map((function(t){return ht("string"==typeof t?t:t.math,i._context.math)}));if(t.tree){var n={data:t.tree,values:[]};return this._fillGroupRowInner(n,0,[r],t.width,t.scaleWidth),n.values}return this._fillTotal(t.data,r,t.width,t.scaleWidth)},t.prototype.aggregateRows=function(t,e){var i={},r=!0;for(var n in e){var o=e[n];i[n]=ht(o,this._context.math),r=!1}return r?null:this._filAggrRows(t.data,i,t.width,t.scaleWidth)},t.prototype.aggregateColumns=function(t,e){var i={},r=!0;for(var n in e){var o=e[n];i[n]=ht(o,this._context.math),r=!1}return r?null:this._filAggrCols(t.data,i,t.width,t.scaleWidth)},t.prototype.mark=function(t,e){var i=[];for(var r in e)i.push([r,e[r]]);if(!i.length)return null;for(var n=[],o=t.width,a=t.data,s=a.length,u=0;u<s;u++){var l=[];n.push(l);for(var c=t.scaleWidth;c<o;c++){var p=a[u][c];if(void 0!==p)for(var h=0;h<i.length;h++){i[h][1](p,t.allRows[c],t.allColumns[u])&&(l[c]?l[c].push(i[h][0]):l[c]=[i[h][0]])}}}return n},t.prototype._fillGroupRowInner=function(t,e,i,r,n){var o=i.length>e,a=t.data;if(o)for(var s=0;s<t.data.length;s++)this._fillGroupRowInner(a[s],e+1,i,r,n);var u=i[e];if(u){var l=this._ops.length,c=function(e){var i=u[(e-n)%l];if(i){var r=t.data.map((function(t){return t.values[e]})).filter((function(t){return void 0!==t}));r.length>0&&(t.values[e]=i(r))}};for(s=n;s<=r;s++)c(s)}},t.prototype._fillTotal=function(t,e,i,r){var n=[];if(e)for(var o=this._ops.length,a=function(i){var a=e[(i-r)%o];if(a){var s=t.map((function(t){return t[i]})).filter((function(t){return void 0!==t}));s.length>0&&(n[i]=a(s))}},s=r;s<i;s++)a(s);return n},t.prototype._filAggrRows=function(t,e,i,r){var n=[];if(e)for(var o=function(i){var r=t.map((function(t){return t[i]})).filter((function(t){return void 0!==t}));if(r.length>0){var o=n[i]={};for(var a in e)o[a]=e[a](r)}},a=r;a<i;a++)o(a);return n},t.prototype._filAggrCols=function(t,e,i,r){var n=[];if(e)for(var o=t.length,a=0;a<o;a++){var s=(r?t[a].slice(r):t[a]).filter((function(t){return void 0!==t}));if(s.length>0){var u=n[a]={};for(var l in e)u[l]=e[l](s)}}return n},t.prototype._fillRow=function(t,e,i,r){var n=this,o=n._cols,a=n._group,s=n._ops,u=n._sizes,l=n._rows.length;if(s.length)if(o.length)for(var c=e;c<i;){for(var p=0,h=0;h<o.length;h++)p+=u[h]*a[l+h];var f=this._nextColumn();for(h=0;h<s.length;h++)t[p+r+h]=s[h](c,f);this._cursor=c=f}else for(h=0;h<s.length;h++)t[h+r]=s[h](e,i)},t.prototype._sort=function(){for(var t=this._table,e=this._dims,i=Math.min(t.count(),this._context.limit.raws),r=new Array(i),n=0;n<i;n++)r[n]=n;var o=e.length,a=e.map((function(t){return t.getIndexes()}));return r.sort((function(t,e){for(var i=0;i<o;i++){var r=a[i][t],n=a[i][e];if(r>n)return 1;if(r<n)return-1}return 0})),r},t.prototype._nextRow=function(t){for(var e=this._data,i=this._order,r=this._group,n=this._rows.length,o=!0,a=this._cursor;;){for(var s=i[a],u=0;u<n;u++)e[u][s]!=r[u]&&(t||(r[u]=e[u][s]),o=!1);if(!o)break;a++}return a},t.prototype._nextColumn=function(){for(var t=this,e=t._data,i=t._order,r=t._group,n=t._rows,o=t._cols.length+n.length,a=!0,s=this._cursor;;){for(var u=i[s],l=0;l<o;l++)e[l][u]!=r[l]&&(r[l]=e[l][u],a=!1);if(!a)break;s++}return s},t.prototype._setSizes=function(){for(var t=this._cols.map((function(t){return t.getSize()})),e=this._ops.length||1,i=t.length-1;i>=0;i--){var r=e;e*=t[i],t[i]=r}this._sizes=t},t}(),wt=function(){function t(t){this._columns=t.fields,this.parse(t.data)}return t.prototype.parse=function(t){this._raw=t,this._parse_inner()},t.prototype.prepare=function(){if(!this._prepared){this._prepared=!0;var t=this._raw,e=this._columns.filter((function(t){return 3===t.type}));if(t&&e.length)for(var i=t.length,r=e.length,n=0;n<i;n++)for(var o=0;o<r;o++){var a=e[o],s=a.getter(n);"string"==typeof s&&a.setter(n,new Date(s))}}},t.prototype._parse_inner=function(){var t=this;this._columns.forEach((function(e){var i=e.id;e.getter=function(e){return t._raw[e][i]},e.setter=function(e,r){return t._raw[e][i]=r}}))},t.prototype.getColumn=function(t){return this._columns.find((function(e){return e.id===t}))},t.prototype.count=function(){return this._raw.length},t}(),yt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.parse=function(t){this._parse_init(t.length);for(var e=t.length,i=this._columns.length,r=0;r<e;r++)for(var n=t[r],o=0;o<i;o++){var a=this._columns[o];a.data[r]=n[a.id]}},e.prototype._parse_init=function(t){this._columns.forEach((function(e){var i=e.data=new Array(t);e.getter=function(t){return i[t]},e.setter=function(t,e){return i[t]=e}}))},e.prototype.count=function(){return this._columns[0].data.length},e}(wt),bt={round:function(t){return Math.round(t)},sum:function(t){return t.reduce((function(t,e){return t+e}),0)},min:function(t){return t.reduce((function(t,e){return e<t?e:t}),t.length?t[0]:0)},max:function(t){return t.reduce((function(t,e){return e>t?e:t}),t.length?t[0]:0)},avg:function(t){return t.length?t.reduce((function(t,e){return t+e}),0)/t.length:0},wavg:function(t,e){if(!t.length)return 0;for(var i=0,r=0,n=t.length-1;n>=0;n--)i+=e[n],r+=t[n]*e[n];return r/i},count:function(t){return t.length},any:function(t){return t.length?t[0]:null}},xt={eq:function(t){return function(e){return e==t}},neq:function(t){return function(e){return e!=t}},gt:function(t){return function(e){return e>t}},gte:function(t){return function(e){return e>=t}},lt:function(t){return function(e){return e<t}},lte:function(t){return function(e){return e<=t}},in:function(t){return function(e){return t[e]}},hasPrefix:function(t){return function(e){return 0===e.indexOf(t)}},contains:function(t){return function(e){return-1!==e.indexOf(t)}}},St={year:function(t){return t.getFullYear()},month:function(t){return t.getMonth()},day:function(t){return t.getDay()},hour:function(t){return t.getHours()},minute:function(t){return t.getMinutes()}},Ct=function(){function t(t){var e=this;this._tables={},this._dimensions={},this._preds=Object.assign({},St),this._maths=Object.assign({},bt),this._comps=Object.assign({},xt),t&&t.tables&&t.tables.forEach((function(t){return e.addTable(t)})),t&&t.dimensions&&t.dimensions.forEach((function(t){return e.addDimension(t)}))}return t.prototype.addPredicate=function(t,e){this._preds[t.toLowerCase()]=e},t.prototype.addMath=function(t,e){this._maths[t.toLowerCase()]=e},t.prototype.addComparator=function(t,e){this._comps[t.toLowerCase()]=e},t.prototype.getDimension=function(t){return this._dimensions[t]},t.prototype.addDimension=function(t){if(!this._dimensions[t.id]){var e=this._tables[t.table],i=this._predicateGetter(e,t.rule.by);this._dimensions[t.id]=new ut(e,i,t.label||t.id,t.meta||t,t.sort)}},t.prototype.resetDimensions=function(t,e){var i=this,r=this._dimensions;this._dimensions={},t&&t.forEach((function(t){var n=r[t.id];e&&n?i._dimensions[t.id]=n:i.addDimension(t)}))},t.prototype.addTable=function(t){var e="raw"===(t.driver||"raw")?wt:yt,i=this._tables[t.id]=new e(t);t.prepare&&i.prepare()},t.prototype.getTable=function(t){return this._tables[t]},t.prototype.compact=function(t,e){var i=this,r=e.rows,o=e.cols,a=e.filters,s=e.limit,u=this._tables[t],l=r?r.map((function(t){return i._dimensions[t]})):[],c=o?o.map((function(t){return i._dimensions[t]})):[];n(l,c).forEach((function(t){return t.prepare()}));var p=new _t(u,l,c,a,{getter:this._predicateGetter.bind(this),math:this._maths,compare:this._comps,limit:Object.assign({rows:1e4,columns:5e3,raws:1/0},s||{})});return new lt(p)},t.prototype._predicateGetter=function(t,e){var i=e.indexOf("(");if(-1!==i){var r=this._preds[e.substr(0,i).toLowerCase()];e=e.substr(i+1,e.length-i-2);var n=t.getColumn(e).getter;return function(t){return r(n(t))}}return t.getColumn(e).getter},t}(),$t=function(){function t(t){this._app=t,this._store={},this._data=[],this._filtersHash={},this._state=t.getState(),this._initRengine()}return t.prototype._setOperations=function(){this.operations=[{id:"sum"},{id:"min"},{id:"max"},{id:"avg"},{id:"wavg"},{id:"count"},{id:"any"}];var t=this._app.config.operations;if(t)for(var e in t)this._reng.addMath(e,t[e]),this.operations.push({id:e})},t.prototype._setFilters=function(){var t=function(t){e._reng.addComparator(t,(function(e){return function(i){return"date"==t&&(i=i.valueOf()),!e||(e.includes?-1!=e.includes.indexOf(i):!e.condition.filter||webix.filters[t][e.condition.type](i,e.condition.filter))}}))},e=this;for(var i in webix.filters)t(i)},t.prototype._setPredicates=function(){var t=this._app.config.predicates;if(t)for(var e in t)this._reng.addPredicate(e,t[e])},t.prototype.getFields=function(t){var e=this._app.config.fields;if(!e)for(var i in e=[],t){var r=void 0,n=typeof t[i];switch(n){case"string":r="text";break;case"number":r=n;break;default:r="date"}e.push({id:i,value:i,type:r})}return e},t.prototype.getData=function(t){var e=this;return!Object.keys(this._store).length||t?this._app.getService("backend").data().then((function(t){return e._filtersHash={},e._table=e.getTable(t),e._reng.addTable(e._table),e._store=e.getPivotData(),e._store})):(this._store=this.getPivotData(),webix.promise.resolve(this._store))},t.prototype._initRengine=function(){this._reng=new Ct,this._setFilters(),this._setOperations(),this._setPredicates()},t.prototype.getPivotData=function(){var t=this;if(!this._table)return{data:[],header:[],total:[],marks:[]};this.setDimensions();for(var e={},i=function(t){var i,n=r._state.structure.filters[t],o=r._state.fields.find((function(t){return t.id==n.name}));e[n.name]=((i={})[o.type]=n.value,i)},r=this,n=0;n<this._state.structure.filters.length;n++)i(n);var o=this._reng.compact(this._table.id,{rows:this.getRows(),cols:this.getColumns(),limit:this.getLimits()}),a=this._state.structure.values,s=[],u=[];for(n=0;n<a.length;n++){var l=a[n].name;l=webix.isArray(l)?l.join(","):l;var c=a[n].format,p=a[n].operation,h=a[n].color,f=l?p+"("+l+")":p;s.push({math:f,label:l,meta:{operation:p,format:c,color:h}}),u.push(f)}var d=this._state.datatable,g={},v={},m={};d.minY&&(g.min="min(n)",m.webix_min_y=function(t,e){return t===e.min}),d.maxY&&(g.max="max(n)",m.webix_max_y=function(t,e){return t===e.max}),d.minX&&(v.min="min(n)",m.webix_min_x=function(t,e,i){return t===i.min}),d.maxX&&(v.max="max(n)",m.webix_max_x=function(t,e,i){return t===i.max});var _,w,y=new Array(s.length);if(d.footer)for(n=0;n<s.length;n++){p=s[n].meta.operation;"sumOnly"==d.footer&&"sum"!=p||(-1!=p.indexOf("(")?p="sum":"wavg"==p&&(p="avg"),y[n]=p+"(group)")}if("table"==this._state.mode)_=o.toArray({filters:e,ops:s,aggregateRows:g,aggregateColumns:v,marks:m,total:y,cleanRows:d.cleanRows}),w=this.getHeader(o,_),_.data=_.data.map((function(t,e){return t.unshift(e+1),t.id=e+1,t}));else{var b=[];for(n=0;n<this.getRows().length-1;n++)b.push(u);if(_=o.toNested({filters:e,ops:s,groupOps:b,aggregateRows:g,aggregateColumns:v,marks:m,total:y}),"tree"!=this._state.mode)return this.getChartData(o,_,s);w=this.getHeader(o,_),_.tree=_.tree.map((function(e){return t._toTree(e)}))}return{data:_.tree?_.tree:_.data,header:w,marks:_.marks,total:_.total}},t.prototype._toTree=function(t){var e=this,i=t.values;return i.unshift(""),t.data?(i.open=!0,i.data=t.data.map((function(t){return e._toTree(t)}))):i.id=t.id,i},t.prototype.getTable=function(t){var e=this.getFields(t[0]);return this._state.fields=e,this._data=t=this.prepareData(t,e),{id:"webixpivot"+webix.uid(),prepare:!0,driver:"raw",fields:webix.copy(e),data:t}},t.prototype.prepareData=function(t,e){return(e=e.filter((function(t){return t.prepare||"date"==t.type}))).length&&(t=t.map((function(t){return e.forEach((function(e){t[e.id]=e.prepare?e.prepare(t[e.id]):new Date(t[e.id])})),t}))),t},t.prototype.collectFieldValues=function(t){if(this._filtersHash[t])return this._filtersHash[t];for(var e=this.getField(t),i={},r=[],n=0;n<this._data.length;n++){var o=this._data[n][t];(o||0===o)&&("date"==e.type&&(o=o.valueOf()),i[o]||(i[o]=!0,r.push({value:o,id:o})))}return this._filtersHash[t]=r,r},t.prototype.fixMath=function(t){var e=this._app.getService("locale")._,i=this._state.fields,r=new RegExp(i.map((function(t){return"\\b"+t.id+"\\b(?!\\()"})).join("|"),"g"),n=this.operations,o=new RegExp(n.map((function(t){return"\\b"+t.id+"\\b\\("})).join("|"),"g");return t.replaceAll(r,(function(t){return i.find((function(e){return e.id==t})).value})).replaceAll(o,(function(t){return e(t.substring(0,t.length-1))+"("}))},t.prototype.getField=function(t){return this._state.fields.find((function(e){return e.id==t}))},t.prototype.getColumns=function(){var t=this._state.structure;return"chart"==this._state.mode&&t.groupBy?[t.groupBy]:t.columns},t.prototype.getRows=function(){return"chart"!=this._state.mode?this._state.structure.rows:[]},t.prototype.getLimits=function(){return{}},t.prototype.getHeader=function(t,e){var i=t.toXHeader(e,{meta:!0,nonEmpty:!0}),r=i.data,n=[];return i.nonEmpty.forEach((function(t){n.push({id:t+1,header:r.map((function(e){e=e[t]&&!webix.isUndefined(e[t].text)?e[t]:{text:e[t]||""};var r=i.meta[t]&&i.meta[t].operation;return r&&(e.operation=r),e})),format:i.meta[t]&&i.meta[t].format})})),n},t.prototype.setDimensions=function(){this._reng.resetDimensions();for(var t=this.getColumns().concat(this.getRows()||[]),e=0;e<t.length;e++){var i=this.getField(t[e]);this._reng.addDimension({id:t[e],table:this._table.id,label:t[e],rule:{by:i.predicate?i.predicate+"("+t[e]+")":t[e]}})}},t.prototype.getChartData=function(t,e,i){var r=[],n=[];if(e.data.length)for(var o=webix.copy(e.data[0]),a=this._state.structure.groupBy?t.toXHeader(e).data[0]:o.map((function(){return""})),s=0;o.length;){var u=o.splice(0,i.length);if(!u.length)break;u.push(a[s].text||a[s]),r.push(u),s+=i.length}for(var l=0;l<i.length;l++)n.push({text:i[l].label||i[l].meta.operation,operation:i[l].meta.operation,color:i[l].meta.color});return{data:r,values:n}},t.prototype.getPalette=function(){return[["#e33fc7","#a244ea","#476cee","#36abee","#58dccd","#a7ee70"],["#d3ee36","#eed236","#ee9336","#ee4339","#595959","#b85981"],["#c670b8","#9984ce","#b9b9e2","#b0cdfa","#a0e4eb","#7faf1b"],["#b4d9a4","#f2f79a","#ffaa7d","#d6806f","#939393","#d9b0d1"],["#780e3b","#684da9","#242464","#205793","#5199a4","#065c27"],["#54b15a","#ecf125","#c65000","#990001","#363636","#800f3e"]]},t.prototype.getValueColor=function(t){var e=this.getPalette(),i=t/e[0].length;i=i>e.length?0:parseInt(i,10);var r=t%e[0].length;return e[i][r]},t.prototype.clearAll=function(){this._app.config.fields=null,this._state.fields=[],this._app.setStructure({}),delete this._table,this._store=this.getPivotData(),this._data=[],this._filtersHash={}},t}(),Vt=function(){function t(t,e){this.app=t,this._url=e}return t.prototype.url=function(t){return this._url+(t||"")},t.prototype.data=function(){return webix.ajax(this.url()).then((function(t){return t.json()}))},t}(),kt=function(t){function e(e){var i=this,n=e.mode||"tree",o=e.structure||{},a=e.chart||{};webix.extend(a,{type:"bar",scale:"linear",lines:!0}),delete a.id;var s=e.datatable||{};delete s.id;var u,l,c,p=B({mode:n,structure:o,readonly:e.readonly||!1,fields:e.fields||[],datatable:s,chart:a,config:!1}),h={router:y,version:"9.2.2",debug:!0,compactWidth:720,start:"main/"+("chart"==n?"chart":"table"),params:{state:p,forceCompact:e.compact}};return(i=t.call(this,r(r({},h),e))||this).setService("backend",new(i.dynamic(Vt))(i,i.config.url)),i.setService("local",new(i.dynamic($t))(i,e)),c={updateConfig:function(t){var e=u.getRoot(),i=e.$view;l?l&&!i.id&&(i.id=l):(i.id?l=i.id:i.id=l="webix_"+webix.uid(),webix.html.addStyle(".webix_win_inside *:not(.webix_modal_box):not(.webix_modal_cover){ z-index: 0; }"),webix.html.addStyle("#"+l+"{ position: relative; }"),webix.html.addStyle("#"+l+" .webix_window{ z-index:2 !important; }"),webix.html.addStyle("#"+l+" .webix_disabled{ z-index:1 !important; }")),t.container=l,t.fullscreen&&(t._fillApp=!0,delete t.fullscreen),t.on||(t.on={});var r=!0,n=t.on.onShow;return t.on.onShow=function(){var t=this;n&&n.apply(this,arguments),r&&(this.$setSize=function(i,r){H(t,e,!0),webix.ui.window.prototype.$setSize.apply(t,[i,r])},z(this,u),r=null),webix.callEvent("onClick",[]),webix.html.addCss(i,"webix_win_inside"),e.disable(),H(this,e)},t}},(u=i).setService("jet-win",c),o=i.prepareStructure(o,!0),i.use(T,i.config.locale||{lang:"en",webix:{en:"en-US"}}),i}return i(e,t),e.prototype.dynamic=function(t){return this.config.override&&this.config.override.get(t)||t},e.prototype.require=function(t,e){return"jet-views"===t?ot[e]:"jet-locales"===t?Rt[e]:null},e.prototype.getState=function(){return this.config.params.state},e.prototype.setStructure=function(t){this.getState().structure=this.prepareStructure(t)},e.prototype.getStructure=function(){return this.getState().structure},e.prototype.prepareStructure=function(t,e){var i=this.getState().mode;webix.extend(t,{rows:[],columns:[],values:[],filters:[]}),e?"chart"==i&&t.groupBy||!t.columns.length?t.groupBy&&(t.columns=[t.groupBy]):t.groupBy=t.columns[0]:"chart"!=i?t.groupBy=t.columns[0]:t.groupBy?t.columns[0]!==t.groupBy&&(t.columns=[t.groupBy]):t.columns=[];for(var n=[],o=0;o<t.values.length;o++){var a=t.values[o];if(webix.isArray(a.operation)){a.color=(webix.isArray(a.color)?a.color:[a.color])||[];for(var s=0;s<a.operation.length;s++){var u=r({},a);u.operation=a.operation[s],u.color=a.color&&a.color[s],n.push(u)}}else n.push(a)}for(o=0;o<n.length;o++)n[o].color||(n[o].color=this.getService("local").getValueColor(o));return t.values=n,t},e}(w);webix.protoUI({name:"pivot",app:kt,defaults:{borderless:!1},$init:function(){var t=this;this.name="pivot",this.$view.className+=" webix_pivot";var e=this.$app.getState();for(var i in e)G(e,this.config,i);this.$app.attachEvent("filter:change",(function(e,i){return t.callEvent("onFilterChange",[e,i])}))},$exportView:function(t){var e=this.$app.getRoot().queryView({$mainView:!0});return e.$exportView?e.$exportView(t):e},getState:function(){return this.$app.getState()},getService:function(t){return this.$app.getService(t)},setStructure:function(t){this.$app.setStructure(t)},getStructure:function(){return this.$app.getStructure()},clearAll:function(){this.$app.getService("local").clearAll()}},webix.ui.jetapp);var Pt={Backend:Vt,LocalData:$t},Rt={en:{Done:"Done",Table:"Table",Tree:"Tree",Chart:"Chart","Click to configure":"Click to configure","Configure Pivot":"Configure Pivot",Total:"Total",Columns:"Columns","Add column":"Add column",Rows:"Rows","Add row":"Add row","Clean rows":"Clean rows",Filters:"Filters","Add filter":"Add filter","Group By":"Group By","Chart type":"Chart type","Logarithmic scale":"Logarithmic scale","X axis title":"X axis title","Y axis title":"Y axis title","Scale color":"Scale color","Circled lines":"Circled lines",Lines:"Lines",Line:"Line",Radar:"Radar",Bar:"Bar",Area:"Area",Spline:"Spline","Spline Area":"Spline Area",Values:"Values","Add value":"Add value","Field not defined":"Field not defined",Highlight:"Highlight","Min X":"Min X","Max X":"Max X","Min Y":"Min Y","Max Y":"Max Y",Footer:"Footer",Off:"Off",On:"On","Sum Only":"Sum Only",count:"count",max:"max",min:"min",avg:"avg",wavg:"wavg",any:"any",sum:"sum"}};t.App=kt,t.locales=Rt,t.services=Pt,t.views=ot,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=pivot.min.js.map
